# 航迹管理模块 | TrackManager

高性能、模块化的航迹管理模块。提供完整的航迹生命周期管理、实时可视化、多线程指令处理等功能。为track_project跟踪项目设计。


## 🚀 项目特征
  - **高性能内存管理**：基于环形缓冲区的泛型容器，保留最新的k个航迹
  - **完备航迹生命周期**：创建、更新、融合、删除全流程管理
  - **实时可视化**：基于 OpenCV 的实时航迹与点迹绘制，支持颜色编码和方向指示
  - **多线程指令处理**：优先级驱动的异步指令队列，确保关键操作及时响应
  - **热插拔日志系统**：支持条件编译的日志插件，可在生产环境与调试模式间切换


## 📁 项目结构
```
TrackManager/
├── config/              # 配置文件
├── include/            # 公共头文件
│   ├── defstruct.h     # 数据结构定义
│   └── ManagementService.hpp   # 管理服务接口（唯一需要包含的头文件）
├── src/                # 源代码
│   ├── LatestKBuffer.hpp       # 泛型环形缓冲区
│   ├── TrackerManager.hpp      # 航迹管理核心
│   └── TrackerVisualizer.hpp   # 可视化组件
├── utils/              # 工具库
│   └── Logger.hpp      # 日志系统
├── tests/              # 测试代码
└── build/              # 构建目录
```


## 🔧 环境依赖

### 必需依赖
  - **C++17** 或更高版本
  - **CMake** (>= 3.16)
  - **OpenCV** (>= 4.0) - 可视化功能

### 可选依赖
  - **Spdlog** (>= 1.5.0) - 增强日志功能（通过 `ENABLE_SPDLOG` 启用）
  - **Catch2** (v3.x) - 单元测试框架


## 🏗️ 核心组件

### 1. 泛型环形缓冲区 (`LatestKBuffer<T>`)
  - 循环存储，自动覆盖旧数据
  - 支持定点修改和批量拷贝
  - 内存拷贝策略：POD类型使用 memcpy，非POD类型使用安全循环

### 2. 航迹管理组件 (`TrackerManager`)
  - 依赖**LatestKBuffer**容器设计
  - 内存池管理，仅构造时存在内存申请
  - 支持航迹创建、删除、融合、更新功能支持
  - 具备零拷贝只读接口

### 3. 可视化组件 (`TrackerVisualizer`)
  - 依赖**TrackerManager**结构设计
  - 实时航迹绘制（TODO暂不引入速度）：渐变黑色线条，新点透明度高，历史点透明度低
  - 点迹背景图：根据关联状态显示不同颜色（蓝色已关联，红色未关联）

### 4. 管理服务层 (`ManagementService`)
  - 基于**TrackerVisualizer**、**TrackerManager**组件设计
  - 对外统一接口，继承自 `TrackManagementAPI`
  - 多线程指令处理，优先级顺序：`DRAW -> MERGE -> CREATE -> ADD -> CLEAR_ALL`
  - 线程安全的指令队列和数据缓冲区

## 📊 性能指标

| 组件                  | 操作        | 性能               |
| --------------------- | ----------- | ------------------ |
| **LatestKBuffer**     | 点迹写入    | 0.0145 μs/点       |
| **TrackerManager**    | 航迹创建    | 10.77 μs/个        |
| **TrackerManager**    | 航迹删除    | 10.46 μs/个        |
| **TrackerVisualizer** | 50万点绘制  | 75.5 ms (13.2 FPS) |
| **TrackerVisualizer** | 100万点绘制 | 220.0 ms (4.5 FPS) |

## 🔄 指令处理优先级

系统按照以下优先级顺序处理指令，确保关键操作及时响应：

1. **DRAW** - 点迹绘制指令（最高优先级）
2. **MERGE** - 航迹融合指令
3. **CREATE** - 航迹创建指令
4. **ADD** - 航迹添加指令
5. **CLEAR_ALL** - 清空所有指令

## 🎯 使用方式

### 快速开始
```cpp
#include "include/ManagementService.hpp"

int main() {
    // 创建管理服务实例
    auto service = std::make_unique<track_project::ManagementService>(1000, 500);
    
    // 发送点迹绘制请求
    std::vector<track_project::TrackPoint> point_cloud;
    // ... 填充点迹数据
    service->draw_point_command(point_cloud);
    
    // 发送航迹创建请求
    std::vector<std::array<track_project::TrackPoint, 4>> new_tracks;
    // ... 填充航迹数据
    service->create_track_command(new_tracks);

    // 发送航迹更新请求
    std::vector<std::pair<track_project::TrackerHeader, track_project::TrackPoint>> track_point;
    // ... 填充航迹更新数据
    service->add_track_command(track_point);
    
    return 0;
}
```

### 构建项目
```bash
# 可自行定义bmain.sh脚本
./bmain.sh
```




## 开发日志  
### 2025-10-24 至 2025-10-25
1. **项目框架搭建**
2. **开发工具链集成**
   - 完成VSCode集成GDB调试
   - Git 版本控制（已配置 `.gitignore` 过滤构建产物）
3. **结构设计**
   - latestKbuffer\<T\> ：泛型环形存储容器：循环存储，自动覆盖旧数据；能定点修改航迹点
   - TrackerManager - 航迹生命周期管理器：航迹记录（数据层）、终结管理；事务管理；
   - trackshow -可视化窗口：DEBUG功能用于显示航迹，两个函数接口，读取trackManager的航迹并可视化，另一个是读取外部输入的点迹进行可视化

### 2025-10-26 至 2025-10-26
1. **构建数据层：latestKbuffer\<T\>**
  - 基于环形缓冲区思路设计，仅保留最新的k个数据，数据满的时候自动弹出
  - 目前设计为禁止拷贝容器
  - 仅允许追加写入新x数据和定点修改数据，禁止移除数据**(已移除该功能放到应用层实现)**
  - 批量拷贝输出：智能内存拷贝策略，POD类型使用memcpy，非POD类型使用安全循环
  
### 2025-10-27 至 2025-11-2
1. 删除计算层：由卡尔曼滤波提供外推结果
   - 设计动机：为解决模块间紧耦合问题，提升系统可拆卸性与可维护性，放弃传统的计算层设计。
   - 统一缓冲区结构，航迹结构放到defstruct里面去，缓冲区结构
   - 设计指令结构用于各层通信
2. **航迹管理层设计**
   - 调用latestKBuffer，设计内存池
   - 提供航迹创建，航迹删除，航迹合并（同传感器合批），航迹输出服务
   - 提供航迹更新功能，且自动实现单群识别，航迹判断
   - 支持一键初始化所有航迹
  
### 2025-11-3 至 2025-11-04
1. **日志库**
    - 添加./utils三方库，输出日志
    - 依旧支持插拔设计和异常检测
    - 暂时还没有支持args的写入，等待后续完善
2. 添加友元TrackerManagerDebugger实现航迹管理层调试功能
3. **管理服务层**
    - 去耦合，将对外接口重构为新服务层，组合调用可视化插件，日志插件和航迹管理层
    - 和流水线结构对接，前后端分离
4. 准备重写DEFSTRUCT，完善流水线设计思路

  
### 2025-11-05 至 2025-11-06
1. 完成defstruct流水线结构设计
    - 统一了缓冲区结构，将航迹结构整合到defstruct中
    - 设计了指令结构用于各层间通信，提升模块解耦性
2. 代码质量优化与警告消除
    - 启用三级编译警告（基础警告、UB检测、代码质量），截至11.06没有WARNING了
    - 修复了所有类型转换警告，将非内存相关的size_t统一为std::uint32_t，（基础数据类型任然支持size_t）
3. 确保跨平台数据类型一致性，为未来流水线分离做准备
    - 完成压力测试与性能验证：RELEASE下：
    - 航迹创建: 10.77 μs/个 (2000空航迹)
    - 航迹删除: 10.46 μs/个 (2000满载航迹)
    - 点迹写入: 0.0145 μs/点 (400万点迹)
    - 数据打包: 14.19 ms (244MB数据)
    - 所有核心操作性能均衡，内存池设计达到预期效果
4. 准备开始可视化插件（优先），日志插件（尤其是把string修改为args这个有点急），以及流水线兼容的设计

### 2025-11-07 至 2025-11-08
1. 插件分离：可视化插件拆解为通信插件和显示插件，代表了可视化和接口可视化两个方向
    - 通信插件:1. 支持控制命令实现航迹融合;2. 配置通过Config结构体管理;
    - 可视化插件用OPENCV实现，反正霍夫变换之类的迟早用得上
2. 统一命名规范，加了一堆namespace
3. 出差去了，开发中止

### 2025-11-29 至 2025-11-30
1. 日志插件重构
   - 宏控制机制：支持条件编译切换日志模式或std::cout/std::cerr
   - 退化方式： LOG_DEBUG退化为无输出，LOG_INFO退化为cout，LOG_ERROR退化为cerr
2. 通信插件完善
   - 发送跟踪结果到指定端口
   - 接收控制信息实现航迹融合
3. 本地可视化插件完成，完全形态由通信库结合JS+HTML来实现：
   - 基于 OpenCV 实现了航迹数据的实时可视化显示，进行了全面的单元测试和压力测试
   - 航迹线绘制：黑色渐变线条，新点透明度高，历史点透明度低，新点标注航迹号
   - 经纬度坐标转换：自动映射到图像坐标系
   - 本站数据实时刷新：支持动态更新显示，足够支持单站流水线
      | 航迹数 | 航迹长度 | 总点数 | 平均绘制时间(ms) | 刷新频率(FPS) |
      | ------ | -------- | ------ | ---------------- | ------------- |
      | 500    | 100      | 5万    | 55.269           | 18.1          |
      | 500    | 500      | 25万   | 75.538           | 13.2          |
      | 500    | 1000     | 50万   | 112.364          | 8.9           |
      | 1000   | 100      | 10万   | 92.195           | 10.8          |
      | 1000   | 500      | 50万   | 148.728          | 6.7           |
      | 1000   | 1000     | 100万  | 219.968          | 4.5           |
      | 1500   | 100      | 15万   | 131.268          | 7.6           |
      | 1500   | 500      | 75万   | 220.092          | 4.5           |
      | 1500   | 1000     | 150万  | 328.078          | 3.0           |
4. 此外：外面的CMAKE链接完毕后，内部也要链接一下，不然任然有可能出现找不到某个库的问题
5. 发现耦合度过高，准备进行去耦合，将打包函数从航迹管理器中移除，放到通信类中——开始改动通信类

### 2025-12-1 至 2025-12-6
1. 下面这个通信组件我移除了，丢到一个专门的线程里面去，做成一个单独的工程，改成回调函数注册，避免使用太多系统资源    
   - 通信组件：**TrackerComm**
     - 端口由commondata::Config结构体解析得到，禁止热重载
     - 监听端口，接收命令，执行控制
2. 抽象基类
3.  完成了管理服务层 `ManagementService` 具体实现
   - 完成了 `ManagementService` 具体实现类的开发
   - 修复了编译错误：`TrackerVisualizer` 缺少默认构造函数的问题
   - 实现了工作线程模型，支持异步指令处理
   - 指令处理优先级：DRAW -> MERGE -> CREATE -> ADD -> CLEAR_ALL
   - 关键特性：
     - 线程安全的指令队列管理
     - 数据缓冲区保护，避免数据在队列中失效
     - 异常安全的指令处理机制
     - 完整的资源清理和线程管理
   - 性能优化：
     - 使用条件变量避免CPU空转
     - 预分配缓冲区减少内存分配开销
     - 零拷贝数据引用提高处理效率
   - 测试验证：
     - 成功通过编译，无警告错误
     - 支持多线程并发指令处理
     - 正确处理指令优先级顺序

4. **点迹绘制功能完善**
   - 完善了 `TrackerVisualizer::draw_point_cloud` 函数，支持点迹背景图绘制
   - 功能特性：
     - 支持绘制多个点迹，根据关联状态显示不同颜色（蓝色表示已关联，红色表示未关联）
     - 为速度大于0.1m/s的点迹绘制方向指示线
     - 使用 `convert_to_image_coords` 函数将经纬度坐标转换为图像像素坐标
     - 添加边界检查，跳过超出图像范围的点迹
   - 新增 `DRAW` 指令类型，优先级最高，确保点迹绘制请求能够被立即处理
   - 在 `ManagementService` 中添加了 `draw_point_command` 接口，支持点迹绘制请求
   - 测试验证：
     - 成功绘制20个测试点迹（7个蓝色已关联点迹，13个红色未关联点迹）
     - 点迹绘制与航迹绘制系统集成良好
     - `DRAW` 指令被正确加入队列并优先处理

## 下一步计划
1. 集成可视化插件和日志插件
2. 添加流水线调度器，协调各级流水线处理
3. 完善配置管理系统
4. 进行集成测试和性能优化
5. 开发通信组件，支持分布式部署
